<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pi Audio Visualizer</title>
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: black;
      color: #33ff33;
      font-family: 'VT323', monospace;
      overflow: hidden;
    }
    #topbar {
      width: 100%;
      height: 50px;
      background-color: #0d0011;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      box-sizing: border-box;
      border-bottom: 1px solid #33ff33;
    }
    #logo {
      color: #33ff33;
      font-size: 24px;
      letter-spacing: 1px;
    }
    #nav-buttons {
      display: flex;
      gap: 15px;
    }
    .nav-btn {
      color: #33ff33;
      background: none;
      border: 1px solid #33ff33;
      padding: 5px 10px;
      font-family: 'VT323', monospace;
      font-size: 18px;
      cursor: pointer;
    }
    #terminal {
      position: absolute;
      left: 0;
      top: 50px;
      width: 20%;
      height: calc(100% - 50px);
      background-color: black;
      border-right: 1px solid #33ff33;
      box-sizing: border-box;
      padding: 20px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-size: 24px;
      scrollbar-color: #0f0013 black;
      scrollbar-width: thin;
    }
    #terminal::-webkit-scrollbar {
      width: 10px;
    }
    #terminal::-webkit-scrollbar-track {
      background: black;
    }
    #terminal::-webkit-scrollbar-thumb {
      background-color: #0f0013;
      border: 2px solid black;
      border-radius: 5px;
    }
    canvas {
      position: absolute;
      left: 20%;
      top: 50px;
      z-index: -1;
    }
    #controls {
      position: absolute;
      bottom: 20px;
      left: 20px;
      right: 20px;
      display: flex;
      justify-content: space-evenly;
      align-items: center;
      z-index: 5;
    }
    .control-btn {
      min-width: 100px;
      height: 42px;
      font-family: 'VT323', monospace;
      font-size: 18px;
      background-color: #0d0011;
      color: #33ff33;
      border: 1px solid #33ff33;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #pi-output {
      max-height: calc(100% - 90px);
      overflow-y: auto;
      display: block;
      word-wrap: break-word;
      white-space: normal;
    }
  </style>
</head>
<body>

<!-- TOP BAR -->
<div id="topbar">
  <div id="logo">Ï€ Visualizer</div>
  <div id="nav-buttons">
    <button class="nav-btn">About</button>
    <button class="nav-btn">Donate</button>
  </div>
</div>

<!-- TERMINAL DISPLAY -->
<div id="terminal">
  <div id="pi-output">PI:<br></div>
  <div id="controls">
    <button id="toggle-btn" class="control-btn">â–¶</button>
    <button id="ambient-btn" class="control-btn">ðŸŒŒ</button>
  </div>
</div>

<script>
  let piDigits = '';
  let index = 0;
  let synth;
  let scratchPlayers = {};
  let digitPlayers = {};
  let darkPulse;
  let circles = [];
  let triangles = [];
  let pulses = [];
  let intervalId = null;
  let hasStarted = false;

  const modes = [
    { name: "Dorian", icon: "ðŸŒŒ", notes: ["C4", "D4", "D#4", "F4", "G4", "A4", "A#4"] },
    { name: "Lydian", icon: "ðŸŽˆ", notes: ["C4", "D4", "E4", "F#4", "G4", "A4", "B4"] },
    { name: "Aeolian", icon: "ðŸŒ’", notes: ["C4", "D4", "D#4", "F4", "G4", "G#4", "A#4"] }
  ];
  let currentMode = 0;
  let notes = modes[currentMode].notes;

  async function loadPi() {
    const resp = await fetch('pi1m.txt');
    piDigits = (await resp.text()).replace(/\D/g, '');
  }

  async function loadScratchSamples() {
    for (let i = 0; i < 10; i++) {
      const gainNode = new Tone.Gain(0.1).toDestination();
      digitPlayers[i] = new Tone.Player(`samples/digit${i}.wav`).connect(gainNode);
    }
    const darkGain = new Tone.Gain(0.2).toDestination();
    darkPulse = new Tone.Player("samples/darkPulse.wav").connect(darkGain);
  }
  loadPi();
  loadScratchSamples();

  document.getElementById("toggle-btn").onclick = async () => {
    await Tone.start();
    if (!synth) {
      const tremolo = new Tone.Tremolo(16, 0.7).start();
      const reverb = new Tone.Reverb({ decay: 3, wet: 0.3 }).toDestination();
      synth = new Tone.PolySynth().connect(tremolo).connect(reverb);
    }

    const toggleBtn = document.getElementById("toggle-btn");

    if (intervalId) {
      clearInterval(intervalId);
      intervalId = null;
      toggleBtn.textContent = "â–¶";
    } else {
      if (!hasStarted) {
        document.getElementById("pi-output").innerHTML += "3.";
        piDigits = piDigits.replace(/^3/, '');
        hasStarted = true;
      }
      intervalId = setInterval(playNextDigit, 600);
      toggleBtn.textContent = "â¸";
    }
  };

  document.getElementById("ambient-btn").onclick = () => {
    currentMode = (currentMode + 1) % modes.length;
    notes = modes[currentMode].notes;
    document.getElementById("ambient-btn").textContent = modes[currentMode].icon;
  };

  function playNextDigit() {
    if (!piDigits || index >= piDigits.length) return;

    const digit = parseInt(piDigits[index]);
    if (digitPlayers[digit]) digitPlayers[digit].start();

    if ((index + 1) % 10 === 0 && darkPulse) {
      darkPulse.start();
    }

    document.getElementById("pi-output").innerHTML += piDigits[index];

    const now = millis();
    if (digit % 2 === 0) {
      circles.push({
        x: random(width),
        y: random(height),
        r: 0,
        color: color(random(100, 255), 0, random(100, 255)),
        created: now
      });
    } else {
      const spacing = width / 12;
      const xIndex = triangles.length % 12;
      triangles.push({
        x: xIndex * spacing + spacing / 2,
        y: 0,
        size: spacing * 0.6,
        color: color(random(100, 255), 0, random(100, 255)),
        created: now
      });
    }

    if ((index + 1) % 33 === 0) {
      const wobbleGain = new Tone.Gain(0).toDestination();
      const filter = new Tone.Filter(100, "lowpass").connect(wobbleGain);
      const osc = new Tone.Oscillator(40, "sine").connect(filter);
      wobbleGain.gain.linearRampToValueAtTime(0.4, Tone.now() + 1);
      wobbleGain.gain.linearRampToValueAtTime(0.0, Tone.now() + 30);
      osc.start().stop("+30");
      osc.onstop = () => {
        osc.dispose();
        filter.dispose();
        wobbleGain.dispose();
      };
      pulses.push({ start: now, duration: 30 * 1000 });
    }

    index++;
  }

  function setup() {
    createCanvas(windowWidth * (4 / 5), windowHeight - 50);
    frameRate(60);
    pixelDensity(0.4);
  }

  function draw() {
    background(0, 25);
    let now = millis();
    noStroke();
    for (let c of circles) {
      let age = now - c.created;
      let alpha = age > 50000 ? map(age, 50000, 60000, 255, 0) : 255;
      fill(red(c.color), green(c.color), blue(c.color), alpha);
      ellipse(c.x, c.y, c.r);
      c.r += 2;
    }
    circles = circles.filter(c => now - c.created < 60000);
    if (circles.length > 300) circles.splice(0, circles.length - 300);

    for (let t of triangles) {
      const age = now - t.created;
      const alpha = age > 50000 ? map(age, 50000, 60000, 255, 0) : 255;
      fill(red(t.color), green(t.color), blue(t.color), alpha);
      t.y += 2;
      const s = t.size;
      triangle(t.x, t.y, t.x - s / 2, t.y + s, t.x + s / 2, t.y + s);
    }
    triangles = triangles.filter(t => now - t.created < 60000);
    if (triangles.length > 300) triangles.splice(0, triangles.length - 300);

    for (let p of pulses) {
      let elapsed = now - p.start;
      if (elapsed < p.duration) {
        let alpha = elapsed < 15000 ? 255 : map(elapsed, 15000, p.duration, 255, 0);
        for (let y = 0; y < height; y += 10) {
          strokeWeight(random(1, 4));
          stroke(0, 255, 0, alpha);
          noFill();
          beginShape();
          for (let x = 0; x < width; x += 10) {
            let yOffset = sin((x + elapsed * 0.05) * 0.05) * 10;
            vertex(x, y + yOffset);
          }
          endShape();
        }
      }
    }
    pulses = pulses.filter(p => now - p.start < p.duration);
    if (pulses.length > 100) pulses.splice(0, pulses.length - 100);
  }

  function windowResized() {
    resizeCanvas(windowWidth * (4 / 5), windowHeight - 50);
  }
</script>


</body>
</html>
